<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Simulator - SGO Core</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        nexus: '#6366f1',
                        nexusDark: '#4f46e5',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen font-sans">
    <div class="container mx-auto p-6 max-w-4xl">
        <header class="mb-8 flex justify-between items-center border-b border-slate-700 pb-4">
            <div>
                <h1 class="text-3xl font-bold text-nexus">Nexus Simulator <span class="text-xs bg-nexus text-white px-2 py-1 rounded-full align-middle ml-2">M2M CLIENT</span></h1>
                <p class="text-slate-400 mt-1">Simulador de Torre de Controle Externa</p>
            </div>
            <div class="text-right text-sm text-slate-500">
                Target: <span class="text-slate-300 font-mono">http://localhost:3000/api/nexus</span>
            </div>
        </header>

        <!-- Configuração de Conexão -->
        <section class="bg-slate-800 rounded-lg p-6 mb-6 shadow-lg border border-slate-700">
            <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-nexus"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                Credenciais de Acesso
            </h2>
            <div class="flex gap-4 items-end">
                <div class="flex-1">
                    <label class="block text-xs uppercase tracking-wide text-slate-500 mb-1">Master Key (X-SGO-MASTER-KEY)</label>
                    <input type="password" id="masterKey" value="sgo-master-key-dev-default" class="w-full bg-slate-900 border border-slate-600 rounded px-4 py-2 text-slate-200 focus:border-nexus focus:outline-none font-mono">
                </div>
                <button onclick="checkHealth()" class="bg-nexus hover:bg-nexusDark text-white font-medium py-2 px-6 rounded transition-colors flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
                    Testar Conexão (Health)
                </button>
            </div>
        </section>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Painel de Status -->
            <section class="bg-slate-800 rounded-lg p-6 shadow-lg border border-slate-700">
                <h2 class="text-lg font-semibold mb-4 text-emerald-400">Status da Instância</h2>
                <div id="statusDisplay" class="space-y-3 text-sm font-mono text-slate-300">
                    <div class="p-4 bg-slate-900 rounded border border-slate-700 text-center text-slate-500 italic">
                        Aguardando conexão...
                    </div>
                </div>
            </section>

            <!-- Painel de Módulos -->
            <section class="bg-slate-800 rounded-lg p-6 shadow-lg border border-slate-700">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-blue-400">Gerenciamento de Módulos</h2>
                    <button onclick="loadModules()" class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded transition-colors">Atualizar Lista</button>
                </div>
                <div id="modulesList" class="space-y-2 max-h-[300px] overflow-y-auto pr-2">
                    <div class="p-4 bg-slate-900 rounded border border-slate-700 text-center text-slate-500 italic">
                        Clique em "Atualizar Lista" para ver os módulos instalados.
                    </div>
                </div>
            </section>
        </div>

        <!-- Log de Console -->
        <section class="mt-6 bg-black rounded-lg p-4 shadow-lg border border-slate-800 font-mono text-xs h-48 overflow-y-auto">
            <div class="text-slate-500 mb-2 border-b border-slate-800 pb-1">CONSOLE DE RESPOSTAS JSON</div>
            <pre id="consoleOutput" class="text-green-400 whitespace-pre-wrap break-all"></pre>
        </section>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api/nexus';

        function log(data) {
            const el = document.getElementById('consoleOutput');
            const time = new Date().toLocaleTimeString();
            el.innerHTML = `<span class="text-slate-500">[${time}]</span> ${JSON.stringify(data, null, 2)}\n\n` + el.innerHTML;
        }

        function getHeaders() {
            return {
                'Content-Type': 'application/json',
                'X-SGO-MASTER-KEY': document.getElementById('masterKey').value
            };
        }

        async function checkHealth() {
            const display = document.getElementById('statusDisplay');
            display.innerHTML = '<div class="animate-pulse">Conectando...</div>';
            
            try {
                const res = await fetch(`${API_URL}/health`, { headers: getHeaders() });
                const data = await res.json();
                log(data);

                if (res.ok) {
                    display.innerHTML = `
                        <div class="flex justify-between border-b border-slate-700 pb-2">
                            <span>Status:</span>
                            <span class="text-green-400 font-bold">${data.status.toUpperCase()}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Versão:</span>
                            <span>${data.data.version}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Plataforma:</span>
                            <span>${data.data.platform} (${data.data.nodeVersion})</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Uptime:</span>
                            <span>${Math.floor(data.data.uptime)}s</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Database:</span>
                            <span>${data.data.database.type} (${data.data.database.status})</span>
                        </div>
                        <div class="mt-4 pt-2 border-t border-slate-700 text-center">
                            <span class="text-xs text-slate-500">Última atualização: ${new Date(data.timestamp).toLocaleTimeString()}</span>
                        </div>
                    `;
                    // Carrega módulos automaticamente se conectar com sucesso
                    loadModules();
                } else {
                    throw new Error(data.message || 'Erro desconhecido');
                }
            } catch (error) {
                log({ error: error.message });
                display.innerHTML = `
                    <div class="p-3 bg-red-900/30 border border-red-800 rounded text-red-200">
                        <strong>Erro de Conexão:</strong><br>${error.message}
                        <div class="mt-2 text-xs opacity-75">Verifique se a Master Key está correta e se o servidor está rodando.</div>
                    </div>
                `;
            }
        }

        async function loadModules() {
            const list = document.getElementById('modulesList');
            list.innerHTML = '<div class="animate-pulse text-center text-slate-500">Carregando módulos...</div>';

            try {
                const res = await fetch(`${API_URL}/modules`, { headers: getHeaders() });
                const modules = await res.json();
                log(modules);

                if (res.ok) {
                    if (modules.length === 0) {
                        list.innerHTML = '<div class="text-center text-slate-500">Nenhum módulo instalado.</div>';
                        return;
                    }

                    list.innerHTML = modules.map(m => `
                        <div class="flex items-center justify-between p-3 bg-slate-900 rounded border ${m.active ? 'border-blue-900' : 'border-slate-700 opacity-60'}">
                            <div>
                                <div class="font-bold text-slate-200">${m.name}</div>
                                <div class="text-xs text-slate-500">${m.slug} v${m.version}</div>
                            </div>
                            <button 
                                onclick="toggleModule('${m.slug}', ${!m.active})"
                                class="px-3 py-1 rounded text-xs font-bold transition-all ${m.active ? 'bg-red-900/50 text-red-400 hover:bg-red-900' : 'bg-green-900/50 text-green-400 hover:bg-green-900'}"
                            >
                                ${m.active ? 'DESATIVAR' : 'ATIVAR'}
                            </button>
                        </div>
                    `).join('');
                }
            } catch (error) {
                log({ error: error.message });
                list.innerHTML = `<div class="text-red-400 text-center text-sm">Falha ao listar módulos.</div>`;
            }
        }

        async function toggleModule(slug, newState) {
            try {
                const res = await fetch(`${API_URL}/modules/${slug}/toggle`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({ active: newState })
                });
                const data = await res.json();
                log(data);
                
                if (res.ok) {
                    // Recarrega a lista para confirmar visualmente
                    loadModules();
                }
            } catch (error) {
                log({ error: error.message });
                alert('Erro ao alterar status do módulo');
            }
        }
    </script>
</body>
</html>