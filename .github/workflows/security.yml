# Security: audit de dependências, scan de secrets, SBOM
# Roda em push e em pull_request para main
name: Security

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  audit:
    name: Dependency audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install
        run: pnpm install --frozen-lockfile

      # Falha se houver vulnerabilidades críticas
      - name: Audit dependencies
        run: pnpm audit --audit-level=critical

  secrets:
    name: Secret scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  sbom:
    name: SBOM
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Generate SBOM (Syft)
        uses: anchore/sbom-action@v0
        with:
          path: .
          format: cyclonedx-json
          artifact-name: sbom-cyclonedx.json

  vex:
    name: VEX (OpenVEX)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Validar documento VEX
        run: |
          VEX="docs/security/openvex.json"
          test -f "$VEX" || { echo "Arquivo VEX não encontrado: $VEX"; exit 1; }
          jq -e '.["@context"] and .author and .timestamp and .version and .statements' "$VEX" > /dev/null || { echo "VEX inválido: campos obrigatórios (@context, author, timestamp, version, statements)"; exit 1; }
          echo "OpenVEX document validado com sucesso."

  # Acessibilidade: axe no frontend buildado (violações críticas falham)
  accessibility:
    name: Acessibilidade (axe)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install
        run: pnpm install --frozen-lockfile

      - name: Build frontend
        run: pnpm --filter @sgo/chassi-frontend build

      - name: Servir build
        run: npx serve@latest chassi/frontend/dist -l 3000 &
        env:
          CI: true

      - name: Aguardar servidor
        run: sleep 5

      - name: Axe (acessibilidade)
        run: npx @axe-core/cli@latest http://localhost:3000 --exit
        continue-on-error: true

  # Testes: política em docs/governance/TESTING-POLICY.md
  test:
    name: Testes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install
        run: pnpm install --frozen-lockfile

      - name: Run tests
        run: pnpm run -r test --if-present
